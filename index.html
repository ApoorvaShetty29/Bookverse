<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Bookverse</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=DM+Sans:wght@300;400;500;600&family=DM+Mono&display=swap" rel="stylesheet"/>
<style>
:root{--bg:#0a0a0f;--bg2:#111118;--bg3:#1a1a24;--border:rgba(255,255,255,0.07);--text:#f0eee8;--muted:#6b6880;--accent:#c8a96e;--accent2:#7c6af5;--red:#e05c5c;--green:#4ec994;}
*{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;overflow-x:hidden;}
::selection{background:var(--accent);color:#000;}
::-webkit-scrollbar{width:6px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:3px;}

/* NOISE */
.noise{position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:0.35;}

/* ‚îÄ‚îÄ LANDING ‚îÄ‚îÄ */
#landing{min-height:100vh;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;cursor:pointer;background:var(--bg);}
#landing::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at center,rgba(10,10,15,0.5) 0%,rgba(10,10,15,0.1) 50%,rgba(10,10,15,0.75) 100%);z-index:2;pointer-events:none;}
.landing-center{position:relative;z-index:3;text-align:center;pointer-events:none;}
.landing-title{font-family:'Playfair Display',serif;font-size:clamp(64px,14vw,140px);font-weight:900;line-height:1;letter-spacing:-2px;color:var(--text);text-shadow:0 4px 60px rgba(0,0,0,0.9);}
.landing-title em{font-style:italic;color:var(--accent);}
.landing-hint{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:4px;text-transform:uppercase;color:var(--muted);margin-top:16px;opacity:0.7;}
#booksCanvas{position:absolute;inset:0;z-index:1;}
.fbook{position:absolute;transform-style:preserve-3d;}
.fbook-inner{position:relative;border-radius:2px 6px 6px 2px;overflow:hidden;box-shadow:8px 12px 40px rgba(0,0,0,0.7),inset -4px 0 10px rgba(0,0,0,0.4);}
.fbook-inner::after{content:'';position:absolute;left:0;top:0;bottom:0;width:10px;background:rgba(0,0,0,0.3);z-index:2;}
.fbook-inner img{width:100%;height:100%;object-fit:cover;display:block;}
.fbook-fallback{width:100%;height:100%;display:flex;align-items:center;justify-content:center;padding:8px;text-align:center;font-family:'Playfair Display',serif;font-size:11px;line-height:1.3;color:var(--text);}
.fab{position:fixed;bottom:32px;right:32px;width:56px;height:56px;border-radius:50%;background:var(--accent);color:#0a0a0f;font-size:28px;font-weight:300;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 30px rgba(200,169,110,0.4);z-index:50;transition:all 0.2s;line-height:1;}
.fab:hover{background:#e0bf80;transform:scale(1.1) rotate(90deg);}

/* ‚îÄ‚îÄ TRACKER ‚îÄ‚îÄ */
#tracker{display:none;min-height:100vh;}
.t-header{display:flex;align-items:center;justify-content:space-between;padding:14px 32px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(10,10,15,0.96);backdrop-filter:blur(20px);z-index:100;flex-wrap:wrap;gap:10px;}
.t-brand{font-family:'DM Mono',monospace;font-size:12px;letter-spacing:3px;color:var(--accent);cursor:pointer;background:none;border:none;text-transform:uppercase;}
.t-brand:hover{color:#e0bf80;}
.t-nav{display:flex;gap:4px;}
.t-nav-btn{background:none;border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;padding:6px 14px;cursor:pointer;border-radius:2px;transition:all 0.15s;}
.t-nav-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(200,169,110,0.08);}
.t-nav-btn:hover:not(.active){color:var(--text);}
.t-stats{display:flex;gap:20px;flex-wrap:wrap;}
.tstat{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);letter-spacing:1px;}
.tstat span{color:var(--text);}

/* Tab views */
#libraryView{display:block;}
#profileView{display:none;}

/* Toolbar */
.toolbar{padding:14px 32px;border-bottom:1px solid var(--border);display:flex;gap:10px;flex-wrap:wrap;align-items:center;background:var(--bg2);}
.search-wrap{position:relative;flex:1;min-width:200px;max-width:340px;}
.search-wrap input{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:8px 12px 8px 34px;font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border-color 0.2s;border-radius:2px;}
.search-wrap input:focus{border-color:var(--accent);}
.search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:14px;pointer-events:none;}
.search-dropdown{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--bg2);border:1px solid var(--accent);border-radius:4px;z-index:200;max-height:280px;overflow-y:auto;display:none;box-shadow:0 8px 30px rgba(0,0,0,0.5);}
.search-dropdown.open{display:block;}
.sdrop-item{display:flex;align-items:center;gap:10px;padding:8px 12px;cursor:pointer;transition:background 0.15s;border-bottom:1px solid var(--border);}
.sdrop-item:last-child{border-bottom:none;}
.sdrop-item:hover{background:var(--bg3);}
.sdrop-item img{width:28px;height:42px;object-fit:cover;border-radius:2px;flex-shrink:0;background:var(--bg3);}
.sdrop-info strong{font-size:12px;display:block;font-family:'Playfair Display',serif;}
.sdrop-info span{font-size:10px;color:var(--muted);}
.search-clear{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);font-size:16px;cursor:pointer;line-height:1;padding:2px;display:none;transition:color 0.15s;}
.search-clear:hover{color:var(--text);}
.search-wrap input{padding-right:30px;}
.empty-state-filter{padding:32px 48px;grid-column:1/-1;text-align:center;}
.empty-state-filter p{font-family:'Playfair Display',serif;font-size:16px;color:var(--muted);font-style:italic;margin-bottom:10px;}
.empty-state-filter button{background:none;border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;padding:7px 16px;cursor:pointer;border-radius:2px;transition:all 0.15s;}
.empty-state-filter button:hover{border-color:var(--accent);color:var(--accent);}
.sort-sel{background:var(--bg3);border:1px solid var(--border);color:var(--muted);padding:6px 10px;font-family:'DM Mono',monospace;font-size:11px;border-radius:2px;outline:none;cursor:pointer;}
.add-book-btn{margin-left:auto;background:var(--accent);color:#0a0a0f;border:none;padding:8px 18px;font-size:11px;font-weight:600;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;white-space:nowrap;border-radius:2px;}
.add-book-btn:hover{background:#e0bf80;}

/* ‚îÄ‚îÄ YEARLY CHALLENGE PANEL ‚îÄ‚îÄ */
.challenge-panel{background:var(--bg2);border-bottom:1px solid var(--border);padding:22px 32px 18px;}
.challenge-top{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;margin-bottom:16px;flex-wrap:wrap;}
.challenge-count{display:flex;align-items:baseline;gap:6px;}
.challenge-num{font-family:'Playfair Display',serif;font-size:48px;font-weight:900;line-height:1;color:var(--accent);}
.challenge-denom{font-family:'Playfair Display',serif;font-size:24px;color:var(--muted);}
.challenge-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-top:4px;}
.challenge-right{text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:8px;}
.pace-badge{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;padding:4px 10px;border-radius:20px;white-space:nowrap;}
.pace-badge.ahead{background:rgba(78,201,148,0.12);border:1px solid rgba(78,201,148,0.3);color:var(--green);}
.pace-badge.behind{background:rgba(224,92,92,0.12);border:1px solid rgba(224,92,92,0.3);color:var(--red);}
.pace-badge.on-track{background:rgba(200,169,110,0.12);border:1px solid rgba(200,169,110,0.3);color:var(--accent);}
.challenge-goal-btn{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);cursor:pointer;background:none;border:none;letter-spacing:1px;}
.challenge-goal-btn:hover{color:var(--accent);}

/* Book spine slots */
.spine-track{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:14px;}
.spine-slot{width:18px;height:52px;border-radius:2px;flex-shrink:0;transition:transform 0.15s;position:relative;cursor:default;}
.spine-slot.filled{box-shadow:0 2px 8px rgba(0,0,0,0.4);}
.spine-slot.filled:hover{transform:translateY(-3px) scale(1.08);}
.spine-slot.empty{background:var(--bg3);border:1px solid var(--border);}
.spine-slot .spine-tip{position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--border);padding:5px 8px;border-radius:3px;font-size:10px;font-family:'DM Sans',sans-serif;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity 0.15s;z-index:20;max-width:160px;overflow:hidden;text-overflow:ellipsis;}
.spine-slot.filled:hover .spine-tip{opacity:1;}

/* Progress bar */
.challenge-bar-wrap{margin-bottom:14px;}
.challenge-bar-labels{display:flex;justify-content:space-between;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;color:var(--muted);text-transform:uppercase;margin-bottom:5px;}
.challenge-bar{height:6px;background:var(--bg3);border-radius:3px;overflow:hidden;position:relative;}
.challenge-bar-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--accent2),var(--accent));transition:width 0.8s ease;}
.challenge-bar-pace{position:absolute;top:-3px;width:2px;height:12px;background:rgba(255,255,255,0.4);border-radius:1px;transition:left 0.4s;}

/* Month heatmap */
.month-row{display:flex;gap:3px;align-items:flex-end;}
.month-cell{display:flex;flex-direction:column;align-items:center;gap:3px;flex:1;}
.month-bar{width:100%;border-radius:2px 2px 0 0;min-height:3px;transition:height 0.4s ease;background:linear-gradient(180deg,var(--accent2),var(--accent));}
.month-lbl{font-family:'DM Mono',monospace;font-size:8px;color:var(--muted);letter-spacing:0.5px;}
.month-cnt{font-family:'DM Mono',monospace;font-size:8px;color:var(--accent);display:none;}
.month-cell:hover .month-cnt{display:block;}
.month-cell:hover .month-lbl{display:none;}

/* Date on library cards */
.mc-date{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);margin-top:3px;display:flex;align-items:center;gap:4px;}
.mc-date-edit{cursor:pointer;opacity:0.5;transition:opacity 0.15s;font-size:10px;}
.mc-date-edit:hover{opacity:1;color:var(--accent);}
.mc-date-input{background:var(--bg3);border:1px solid var(--accent);color:var(--text);padding:2px 5px;font-family:'DM Mono',monospace;font-size:9px;border-radius:2px;width:110px;outline:none;}

/* AI strip */
.ai-strip{margin:20px 32px;border:1px solid var(--border);background:var(--bg2);padding:18px 22px;display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;}
.ai-strip h3{font-family:'Playfair Display',serif;font-size:19px;margin-bottom:3px;}
.ai-strip p{font-size:12px;color:var(--muted);}
.ai-strip-btn{background:transparent;border:1px solid var(--accent);color:var(--accent);padding:9px 20px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;white-space:nowrap;}
.ai-strip-btn:hover{background:var(--accent);color:#0a0a0f;}
.ai-strip-btn:disabled{opacity:0.45;cursor:default;}
.ai-result{margin:0 32px 20px;border-left:2px solid var(--accent);padding:14px 18px;background:var(--bg2);font-size:14px;line-height:1.8;color:var(--muted);font-style:italic;display:none;}
.ai-result strong{color:var(--text);font-style:normal;}

/* Section */
.section-wrap{padding:0 32px 32px;}
.section-head{display:flex;align-items:center;gap:14px;margin-bottom:18px;padding-bottom:12px;border-bottom:1px solid var(--border);}
.section-head h2{font-family:'Playfair Display',serif;font-size:22px;}
.section-head .count{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);}

/* Currently reading */
.currently-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;margin-bottom:8px;}
.cr-card{background:var(--bg2);border:1px solid var(--border);padding:18px;position:relative;overflow:hidden;border-radius:4px;}
.cr-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent2),var(--accent));}
.cr-top{display:flex;gap:14px;align-items:flex-start;margin-bottom:14px;}
.cr-cover{width:56px;height:84px;object-fit:cover;border-radius:2px;flex-shrink:0;box-shadow:3px 4px 12px rgba(0,0,0,0.5);}
.cr-cover-ph{width:56px;height:84px;flex-shrink:0;border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:24px;}
.cr-info h4{font-family:'Playfair Display',serif;font-size:15px;line-height:1.3;margin-bottom:3px;}
.cr-info p{font-size:11px;color:var(--muted);margin-bottom:7px;}
.cr-badge{display:inline-block;background:rgba(124,106,245,0.12);border:1px solid rgba(124,106,245,0.25);color:var(--accent2);font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;padding:2px 7px;}
.progress-label{font-family:'DM Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:1px;display:flex;justify-content:space-between;margin-bottom:5px;text-transform:uppercase;}
.progress-track{height:5px;background:var(--bg3);border-radius:3px;overflow:hidden;}
.progress-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--accent2),var(--accent));transition:width 0.5s;}
.page-input-row{display:flex;gap:7px;margin-top:10px;align-items:center;}
.page-input-row input{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:5px 9px;font-family:'DM Mono',monospace;font-size:11px;width:72px;outline:none;border-radius:2px;}
.page-input-row input:focus{border-color:var(--accent);}
.page-input-row button{background:var(--bg3);border:1px solid var(--border);color:var(--muted);padding:5px 10px;font-size:10px;cursor:pointer;transition:all 0.15s;border-radius:2px;font-family:'DM Mono',monospace;letter-spacing:1px;}
.page-input-row button:hover{border-color:var(--accent);color:var(--accent);}

/* Library grid */
.mag-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:24px;}
.mag-card{display:flex;flex-direction:column;cursor:default;transition:transform 0.2s;}
.mag-card:hover{transform:translateY(-5px);}
.mc-cover-wrap{width:100%;aspect-ratio:2/3;position:relative;overflow:hidden;background:var(--bg3);border-radius:3px;box-shadow:4px 8px 24px rgba(0,0,0,0.6);}
.mc-cover-img{width:100%;height:100%;object-fit:cover;display:block;}
.mc-cover-fallback{width:100%;height:100%;display:flex;align-items:center;justify-content:center;padding:12px;text-align:center;font-family:'Playfair Display',serif;font-size:13px;color:var(--text);line-height:1.3;}
.mc-info{padding:10px 2px 0;}
.mc-title{font-family:'Playfair Display',serif;font-size:13px;line-height:1.35;margin-bottom:3px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.mc-author{font-size:10px;color:var(--muted);font-style:italic;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:6px;}
.mc-stars{font-size:10px;letter-spacing:1px;}
.mc-actions{display:flex;gap:5px;margin-top:7px;}
.mc-btn{background:transparent;border:1px solid var(--border);color:var(--muted);padding:3px 8px;font-size:9px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;font-family:'DM Mono',monospace;transition:all 0.15s;border-radius:2px;}
.mc-btn:hover{border-color:var(--accent);color:var(--accent);}
.mc-btn.danger:hover{border-color:var(--red);color:var(--red);}
.empty-state{padding:48px;text-align:center;color:var(--muted);font-family:'Playfair Display',serif;font-size:18px;font-style:italic;grid-column:1/-1;}

/* ‚îÄ‚îÄ PROFILE TAB ‚îÄ‚îÄ */
.profile-wrap{padding:32px;}
.profile-hero{display:flex;align-items:center;gap:24px;margin-bottom:32px;padding-bottom:28px;border-bottom:1px solid var(--border);}
.profile-avatar{width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,var(--accent2),var(--accent));display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:26px;font-weight:700;color:#0a0a0f;flex-shrink:0;cursor:pointer;position:relative;}
.profile-avatar:hover::after{content:'‚úé';position:absolute;inset:0;background:rgba(0,0,0,0.5);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;}
.profile-name-wrap{flex:1;}
.profile-name{font-family:'Playfair Display',serif;font-size:28px;font-weight:700;line-height:1;margin-bottom:5px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;}
.profile-name:hover .edit-icon{opacity:1;}
.edit-icon{font-size:14px;color:var(--muted);opacity:0;transition:opacity 0.2s;}
.profile-name-input{font-family:'Playfair Display',serif;font-size:28px;font-weight:700;background:none;border:none;border-bottom:2px solid var(--accent);color:var(--text);outline:none;width:100%;}
.profile-sub{font-size:12px;color:var(--muted);letter-spacing:1px;}

.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:16px;margin-bottom:32px;}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:20px;position:relative;overflow:hidden;}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.stat-card:nth-child(1)::before{background:var(--accent);}
.stat-card:nth-child(2)::before{background:var(--accent2);}
.stat-card:nth-child(3)::before{background:var(--green);}
.stat-card:nth-child(4)::before{background:var(--red);}
.stat-card:nth-child(5)::before{background:#74b9ff;}
.stat-num{font-family:'Playfair Display',serif;font-size:36px;font-weight:700;line-height:1;margin-bottom:4px;}
.stat-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}

.profile-section-title{font-family:'Playfair Display',serif;font-size:18px;margin-bottom:16px;}
.genres-wrap{margin-bottom:32px;}
.genre-bar-row{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
.genre-bar-label{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;color:var(--muted);width:110px;flex-shrink:0;text-align:right;}
.genre-bar-track{flex:1;height:6px;background:var(--bg3);border-radius:3px;overflow:hidden;}
.genre-bar-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--accent2),var(--accent));transition:width 0.6s ease;}
.genre-bar-count{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);width:28px;text-align:right;}

.profile-actions{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:32px;}
.pf-btn{padding:10px 20px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;border-radius:2px;cursor:pointer;transition:all 0.2s;border:1px solid var(--border);background:transparent;color:var(--muted);}
.pf-btn:hover{border-color:var(--accent);color:var(--accent);}
.pf-btn.primary{background:var(--accent);color:#0a0a0f;border-color:var(--accent);}
.pf-btn.primary:hover{background:#e0bf80;}
.pf-btn.danger{border-color:var(--red);color:var(--red);}
.pf-btn.danger:hover{background:var(--red);color:#fff;}

.backup-note{background:var(--bg2);border:1px solid rgba(200,169,110,0.2);border-left:3px solid var(--accent);padding:14px 18px;border-radius:4px;margin-bottom:24px;font-size:12px;color:var(--muted);line-height:1.7;}
.backup-note strong{color:var(--accent);display:block;margin-bottom:4px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.82);display:none;align-items:center;justify-content:center;z-index:500;backdrop-filter:blur(10px);}
.modal{background:var(--bg2);border:1px solid var(--border);padding:30px;width:min(520px,94vw);max-height:90vh;overflow-y:auto;position:relative;border-radius:4px;}
.modal h2{font-family:'Playfair Display',serif;font-size:24px;margin-bottom:4px;}
.modal-sub{font-size:12px;color:var(--muted);margin-bottom:22px;}
.modal-close{position:absolute;top:18px;right:18px;background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;line-height:1;}
.modal-close:hover{color:var(--text);}
.fg{margin-bottom:14px;}
.fg label{display:block;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:7px;}
.fg input,.fg select{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:9px 12px;font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color 0.2s;border-radius:2px;}
.fg input:focus,.fg select:focus{border-color:var(--accent);}
.fg select option{background:var(--bg3);}
.fg-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.toggle-row{display:flex;gap:7px;flex-wrap:wrap;}
.toggle-opt{padding:6px 12px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;cursor:pointer;transition:all 0.15s;border-radius:2px;}
.toggle-opt.sel{border-color:var(--accent);color:var(--accent);background:rgba(200,169,110,0.08);}
.m-stars{display:flex;gap:4px;}
.m-star{font-size:24px;color:var(--bg3);cursor:pointer;transition:color 0.1s;}
.m-star.on{color:var(--accent);}
.modal-actions{display:flex;gap:10px;margin-top:22px;}
.mbtn{padding:11px 24px;font-size:11px;font-weight:600;letter-spacing:2px;text-transform:uppercase;cursor:pointer;border:none;transition:all 0.2s;font-family:'DM Sans',sans-serif;border-radius:2px;}
.mbtn-primary{background:var(--accent);color:#0a0a0f;}
.mbtn-primary:hover{background:#e0bf80;}
.mbtn-ghost{background:transparent;border:1px solid var(--border);color:var(--muted);}
.mbtn-ghost:hover{border-color:var(--muted);color:var(--text);}
/* Modal search */
.modal-search-wrap{position:relative;margin-bottom:0;}
.modal-search-wrap input{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:9px 12px;font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color 0.2s;border-radius:2px;}
.modal-search-wrap input:focus{border-color:var(--accent);}
.modal-search-dropdown{position:absolute;top:calc(100% + 3px);left:0;right:0;background:var(--bg2);border:1px solid var(--accent);border-radius:4px;z-index:600;max-height:240px;overflow-y:auto;display:none;box-shadow:0 10px 40px rgba(0,0,0,0.6);}
.modal-search-dropdown.open{display:block;}
.msdrop-item{display:flex;align-items:center;gap:10px;padding:9px 12px;cursor:pointer;transition:background 0.15s;border-bottom:1px solid var(--border);}
.msdrop-item:last-child{border-bottom:none;}
.msdrop-item:hover{background:var(--bg3);}
.msdrop-item img{width:30px;height:45px;object-fit:cover;border-radius:2px;flex-shrink:0;background:var(--bg3);}
.msdrop-info strong{font-size:13px;display:block;font-family:'Playfair Display',serif;line-height:1.3;}
.msdrop-info span{font-size:10px;color:var(--muted);}
.msdrop-loading{padding:12px;text-align:center;color:var(--muted);font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;}
/* Cover preview */
.cover-preview-wrap{display:flex;gap:14px;align-items:flex-start;margin-bottom:14px;}
.cover-preview{width:70px;height:105px;border-radius:2px;border:1px solid var(--border);flex-shrink:0;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;text-align:center;overflow:hidden;}
.cover-preview img{width:100%;height:100%;object-fit:cover;}
/* Share modal */
.share-preview{background:var(--bg3);border:1px solid var(--border);padding:20px;margin-bottom:14px;display:flex;gap:16px;align-items:flex-start;border-radius:4px;}
.sp-cover{width:70px;height:105px;object-fit:cover;border-radius:2px;flex-shrink:0;box-shadow:3px 4px 12px rgba(0,0,0,0.5);}
.sp-cover-ph{width:70px;height:105px;border-radius:2px;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0;}
.sp-details{flex:1;}
.sp-title{font-family:'Playfair Display',serif;font-size:18px;margin-bottom:3px;}
.sp-author{font-size:12px;color:var(--muted);margin-bottom:10px;font-style:italic;}
.sp-quote{font-style:italic;color:var(--muted);font-size:12px;border-left:2px solid var(--accent);padding-left:10px;line-height:1.6;}
.copy-btn{width:100%;background:var(--accent);color:#0a0a0f;border:none;padding:11px;font-size:11px;font-weight:600;letter-spacing:3px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;border-radius:2px;}
.copy-btn:hover{background:#e0bf80;}
.copied-msg{text-align:center;font-family:'DM Mono',monospace;font-size:10px;color:var(--green);letter-spacing:2px;margin-top:8px;display:none;}
/* Goodreads import */
.gr-import-btn{background:transparent;border:1px solid #3b7a57;color:#5aab7f;padding:5px 12px;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;border-radius:2px;margin-left:auto;}
.gr-import-btn:hover{background:#3b7a57;color:#fff;}
.import-drop{border:2px dashed var(--border);border-radius:4px;padding:28px;text-align:center;cursor:pointer;transition:border-color 0.2s;margin-bottom:14px;}
.import-drop:hover,.import-drop.drag-over{border-color:var(--accent);}
.import-drop p{font-size:13px;color:var(--muted);margin-top:8px;}
.import-drop .drop-icon{font-size:32px;}
.import-results{max-height:260px;overflow-y:auto;margin-bottom:14px;}
.import-book-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);}
.import-book-row img{width:32px;height:48px;object-fit:cover;border-radius:2px;flex-shrink:0;background:var(--bg3);}
.import-book-info{flex:1;min-width:0;}
.import-book-info strong{font-family:'Playfair Display',serif;font-size:13px;display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.import-book-info span{font-size:11px;color:var(--muted);}
.import-book-check{accent-color:var(--accent);width:16px;height:16px;cursor:pointer;flex-shrink:0;}
.import-status{font-family:'DM Mono',monospace;font-size:10px;color:var(--green);letter-spacing:2px;text-align:center;padding:8px;display:none;}
.how-to-box{background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:14px;margin-bottom:16px;font-size:12px;color:var(--muted);line-height:1.8;}
.how-to-box strong{color:var(--accent);font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;display:block;margin-bottom:4px;}

@media(max-width:768px){
  .toolbar,.streak-bar,.t-header,.section-wrap,.ai-strip,.ai-result,.profile-wrap{padding-left:16px;padding-right:16px;}
  .mag-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:16px;}
  .stats-grid{grid-template-columns:1fr 1fr;}
  .profile-hero{flex-wrap:wrap;}
}
</style>
</head>
<body>
<div class="noise"></div>

<!-- ‚ïê‚ïê LANDING ‚ïê‚ïê -->
<div id="landing" onclick="showTracker()">
  <div id="booksCanvas"></div>
  <div class="landing-center">
    <div class="landing-title">Book<em>verse</em></div>
    <div class="landing-hint">Tap anywhere to open your library</div>
  </div>
</div>
<button class="fab" id="landingFab" onclick="event.stopPropagation();openModalFromLanding()" title="Add a book">+</button>

<!-- ‚ïê‚ïê TRACKER ‚ïê‚ïê -->
<div id="tracker">
  <header class="t-header">
    <button class="t-brand" onclick="showLanding()">‚Üê Bookverse</button>
    <div class="t-nav">
      <button class="t-nav-btn active" id="navLibrary" onclick="switchTab('library')">Library</button>
      <button class="t-nav-btn" id="navProfile" onclick="switchTab('profile')">Profile</button>
    </div>
    <div class="t-stats" id="tStats"></div>
  </header>

  <!-- LIBRARY VIEW -->
  <div id="libraryView">
    <div class="challenge-panel" id="challengePanel"></div>
    <div class="toolbar">
      <div class="search-wrap">
        <span class="search-icon">‚åï</span>
        <input type="text" id="searchInput" placeholder="Search your library or find a new book‚Ä¶" oninput="handleLibrarySearch()" autocomplete="off"/>
        <button class="search-clear" id="searchClear" onclick="clearLibrarySearch()" title="Clear search">‚úï</button>
        <div class="search-dropdown" id="searchDropdown"></div>
      </div>
      <select class="sort-sel" id="sortSel" onchange="renderTracker()">
        <option value="newest">Newest Added</option>
        <option value="date">Date Read</option>
        <option value="rating">Top Rated</option>
        <option value="pages">Most Pages</option>
        <option value="alpha">A ‚Üí Z</option>
      </select>
      <button class="add-book-btn" onclick="openModal('add')">+ Add Book</button>
    </div>
    <div class="ai-strip">
      <div><h3>AI Reading Profile</h3><p>Analyse your library and get a personalised next-read recommendation</p></div>
      <button class="ai-strip-btn" id="aiBtn" onclick="getAIInsight()">‚ú¶ Analyse My Taste</button>
    </div>
    <div class="ai-result" id="aiResult"></div>
    <div class="section-wrap" style="padding-top:24px;">
      <div class="section-head">
        <h2>Currently Reading</h2>
        <span class="count" id="crCount">0 books</span>
      </div>
      <div class="currently-grid" id="crGrid"></div>
    </div>
    <div class="section-wrap">
      <div class="section-head">
        <h2>My Library</h2>
        <span class="count" id="libCount">0 books</span>
        <button class="gr-import-btn" onclick="document.getElementById('importModal').style.display='flex'">‚¨Ü Import Goodreads</button>
      </div>
      <div class="mag-grid" id="bookGrid"></div>
    </div>
  </div>

  <!-- PROFILE VIEW -->
  <div id="profileView">
    <div class="profile-wrap">
      <div class="profile-hero">
        <div class="profile-avatar" id="profileAvatar" onclick="editName()"></div>
        <div class="profile-name-wrap">
          <div class="profile-name" id="profileNameDisplay" onclick="editName()">
            <span id="profileNameText">Reader</span>
            <span class="edit-icon">‚úé</span>
          </div>
          <input class="profile-name-input" id="profileNameInput" style="display:none;" onblur="saveName()" onkeydown="if(event.key==='Enter')saveName()"/>
          <div class="profile-sub" id="profileSub">Bookverse member</div>
        </div>
      </div>

      <div class="stats-grid" id="statsGrid"></div>

      <div class="backup-note">
        <strong>üíæ KEEP YOUR LIBRARY SAFE</strong>
        Your books are saved in your browser. To avoid losing them when you redeploy or switch devices, <strong>Export Library</strong> regularly and keep the backup file safe. Use <strong>Import Library</strong> to restore it anytime.
      </div>

      <p class="profile-section-title">Genres in your library</p>
      <div class="genres-wrap" id="genresWrap"></div>

      <p class="profile-section-title">Library actions</p>
      <div class="profile-actions">
        <button class="pf-btn primary" onclick="exportLibrary()">‚¨á Export Library</button>
        <button class="pf-btn" onclick="document.getElementById('importJsonInput').click()">‚¨Ü Import Library</button>
        <input type="file" id="importJsonInput" accept=".json" style="display:none" onchange="importLibrary(event)"/>
        <button class="pf-btn" onclick="changeGoal()">‚öô Reading Goal</button>
        <button class="pf-btn danger" onclick="clearLibrary()">‚úï Clear Library</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê ADD BOOK MODAL ‚ïê‚ïê -->
<div class="overlay" id="addModal" onclick="closeOverlay(event,'addModal')">
  <div class="modal">
    <button class="modal-close" onclick="document.getElementById('addModal').style.display='none'">‚úï</button>
    <h2 id="modalTitle">Add a Book</h2>
    <p class="modal-sub">Type a title ‚Äî pick from suggestions to auto-fill everything</p>
    <div class="cover-preview-wrap">
      <div class="cover-preview" id="coverPreview"><span style="padding:4px;font-size:9px;text-align:center;">No cover</span></div>
      <div style="flex:1;">
        <div class="fg" style="margin-bottom:8px;">
          <label>Title</label>
          <div class="modal-search-wrap">
            <input id="fTitle" placeholder="e.g. The Midnight Library" autocomplete="off" oninput="onModalSearchInput()"/>
            <div class="modal-search-dropdown" id="modalSearchDropdown"></div>
          </div>
        </div>
        <div class="fg" style="margin-bottom:0;">
          <label>Author</label>
          <input id="fAuthor" placeholder="e.g. Matt Haig" oninput="onModalSearchInput()"/>
        </div>
      </div>
    </div>
    <div class="fg-row">
      <div class="fg"><label>Pages</label><input id="fPages" type="number" placeholder="e.g. 328" min="1"/></div>
      <div class="fg"><label>Genre</label>
        <select id="fGenre"><option>Fantasy</option><option>Sci-Fi</option><option>Classic</option><option>Dystopia</option><option>Self-Help</option><option>Romance</option><option>Mystery</option><option>Non-Fiction</option><option>Horror</option><option>Literary Fiction</option><option>Fiction</option></select>
      </div>
    </div>
    <div class="fg"><label>Status</label>
      <div class="toggle-row">
        <button class="toggle-opt sel" id="statusRead" onclick="setStatus('read')">‚úì Read</button>
        <button class="toggle-opt" id="statusReading" onclick="setStatus('reading')">‚ñ∂ Reading</button>
      </div>
    </div>
    <div class="fg" id="currentPageFg" style="display:none;"><label>Current Page</label><input id="fCurrentPage" type="number" placeholder="0"/></div>
    <div class="fg" id="dateReadFg"><label>Date Read</label><input id="fDateRead" type="date"/></div>
    <div class="fg"><label>Rating</label><div class="m-stars" id="mStars"></div></div>
    <div class="modal-actions">
      <button class="mbtn mbtn-primary" onclick="saveBook()">Save Book</button>
      <button class="mbtn mbtn-ghost" onclick="document.getElementById('addModal').style.display='none'">Cancel</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê FINISHED DATE MODAL ‚ïê‚ïê -->
<div class="overlay" id="finishedModal" onclick="closeOverlay(event,'finishedModal')">
  <div class="modal" style="width:min(380px,94vw);">
    <button class="modal-close" onclick="document.getElementById('finishedModal').style.display='none'">‚úï</button>
    <h2>üéâ Finished!</h2>
    <p class="modal-sub">When did you finish reading this book?</p>
    <div class="fg">
      <label>Date Finished</label>
      <input id="finishedDateInput" type="date"/>
    </div>
    <div class="modal-actions">
      <button class="mbtn mbtn-primary" onclick="confirmMarkRead()">Save</button>
      <button class="mbtn mbtn-ghost" onclick="document.getElementById('finishedModal').style.display='none'">Cancel</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê SHARE MODAL ‚ïê‚ïê -->
<div class="overlay" id="shareModal" onclick="closeOverlay(event,'shareModal')">
  <div class="modal">
    <button class="modal-close" onclick="document.getElementById('shareModal').style.display='none'">‚úï</button>
    <h2>Share Recommendation</h2>
    <p class="modal-sub">Copy this to share with friends</p>
    <div class="share-preview" id="sharePreview"></div>
    <button class="copy-btn" onclick="copyShareText()">Copy to Clipboard</button>
    <div class="copied-msg" id="copiedMsg">‚úì Copied to clipboard!</div>
  </div>
</div>

<!-- ‚ïê‚ïê GOODREADS IMPORT MODAL ‚ïê‚ïê -->
<div class="overlay" id="importModal" onclick="closeOverlay(event,'importModal')">
  <div class="modal">
    <button class="modal-close" onclick="document.getElementById('importModal').style.display='none'">‚úï</button>
    <h2>Import from Goodreads</h2>
    <p class="modal-sub">Upload your Goodreads CSV export to import your library</p>
    <div class="how-to-box">
      <strong>HOW TO EXPORT FROM GOODREADS</strong>
      1. Go to <b style="color:var(--text)">goodreads.com ‚Üí My Books</b><br/>
      2. Click <b style="color:var(--text)">Import & Export</b> in the left sidebar<br/>
      3. Click <b style="color:var(--text)">Export Library</b> ‚Äî you'll get a CSV file<br/>
      4. Upload that file below ‚Üì
    </div>
    <div class="import-drop" id="importDrop" onclick="document.getElementById('csvFileInput').click()"
      ondragover="event.preventDefault();this.classList.add('drag-over')"
      ondragleave="this.classList.remove('drag-over')"
      ondrop="handleFileDrop(event)">
      <div class="drop-icon">üìÑ</div>
      <strong style="color:var(--text);display:block;margin:6px 0 4px;">Click to upload or drag & drop</strong>
      <p>Goodreads CSV export file (.csv)</p>
      <input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="handleFileSelect(event)"/>
    </div>
    <div class="import-results" id="importResults" style="display:none"></div>
    <div class="import-status" id="importStatus"></div>
    <div id="importActions" style="display:none">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
        <input type="checkbox" id="selectAll" checked onchange="toggleSelectAll(this.checked)" style="accent-color:var(--accent);width:14px;height:14px;cursor:pointer;"/>
        <label for="selectAll" style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;color:var(--muted);cursor:pointer;">SELECT ALL</label>
        <span id="importCount" style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);margin-left:auto;"></span>
      </div>
      <button class="mbtn mbtn-primary" style="width:100%;" onclick="importSelected()">Import Selected Books</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA & PERSISTENCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FALLBACK_COLORS=["#c8a96e","#7c6af5","#e05c5c","#4ec994","#74b9ff","#fd79a8","#fdcb6e","#a29bfe","#e17055","#55efc4"];
const DEFAULT_BOOKS=[
  {id:1,title:"The Hobbit",author:"J.R.R. Tolkien",color:"#c8a96e",pages:310,currentPage:310,genre:"Fantasy",rating:5,status:"read",dateRead:"2026-01-14",coverUrl:"https://covers.openlibrary.org/b/isbn/9780547928227-L.jpg"},
  {id:2,title:"Dune",author:"Frank Herbert",color:"#7c6af5",pages:412,currentPage:412,genre:"Sci-Fi",rating:5,status:"read",dateRead:"2026-02-03",coverUrl:"https://covers.openlibrary.org/b/isbn/9780441013593-L.jpg"},
  {id:3,title:"1984",author:"George Orwell",color:"#e05c5c",pages:328,currentPage:328,genre:"Dystopia",rating:5,status:"read",dateRead:"2026-02-18",coverUrl:"https://covers.openlibrary.org/b/isbn/9780451524935-L.jpg"},
  {id:4,title:"Little Women",author:"Louisa May Alcott",color:"#4ec994",pages:449,currentPage:449,genre:"Classic",rating:4,status:"read",dateRead:"2025-11-22",coverUrl:"https://covers.openlibrary.org/b/isbn/9780147514011-L.jpg"},
  {id:5,title:"Atomic Habits",author:"James Clear",color:"#fd79a8",pages:319,currentPage:180,genre:"Self-Help",rating:4,status:"reading",dateRead:null,coverUrl:"https://covers.openlibrary.org/b/isbn/9780735211292-L.jpg"},
];

let books=[];
let yearGoal=12;
let readerName='Reader';

function saveAll(){
  try{
    localStorage.setItem('bv_books',JSON.stringify(books));
    localStorage.setItem('bv_goal',String(yearGoal));
    localStorage.setItem('bv_name',readerName);
  }catch(e){}
}
function loadAll(){
  try{
    const s=localStorage.getItem('bv_books');
    books=s?JSON.parse(s):JSON.parse(JSON.stringify(DEFAULT_BOOKS));
    yearGoal=parseInt(localStorage.getItem('bv_goal')||'12');
    readerName=localStorage.getItem('bv_name')||'Reader';
  }catch(e){books=JSON.parse(JSON.stringify(DEFAULT_BOOKS));}
}
loadAll();

let selRating=4,selStatus='read',editingId=null,shareBookId=null,pendingCoverUrl=null;
let parsedImportBooks=[],searchDebounce=null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OPEN LIBRARY API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOK SEARCH ‚Äî Google Books API (primary, best coverage)
//  + Open Library for cover fallback
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function searchBooks(query){
  // 1. Try Google Books (much wider catalogue, handles unusual titles)
  try{
    const q=encodeURIComponent(query);
    const res=await fetch(`https://www.googleapis.com/books/v1/volumes?q=${q}&maxResults=12&printType=books`,{signal:AbortSignal.timeout(8000)});
    if(res.ok){
      const data=await res.json();
      if(data.items?.length){
        return data.items.map(item=>{
          const info=item.volumeInfo||{};
          let coverUrl=info.imageLinks?.thumbnail||info.imageLinks?.smallThumbnail||null;
          // Google thumbnail URLs sometimes use http ‚Äî upgrade to https
          if(coverUrl) coverUrl=coverUrl.replace(/^http:/,'https:').replace('zoom=1','zoom=2');
          return{
            title:info.title||'Unknown',
            author:(info.authors||['Unknown']).slice(0,2).join(', '),
            pages:info.pageCount||0,
            coverUrl
          };
        }).filter(b=>b.title!=='Unknown');
      }
    }
  }catch(e){}

  // 2. Fallback: Open Library
  try{
    const q=encodeURIComponent(query);
    const res=await fetch(`https://openlibrary.org/search.json?q=${q}&limit=12&fields=isbn,cover_edition_key,cover_i,title,author_name,number_of_pages_median`,{signal:AbortSignal.timeout(8000)});
    if(res.ok){
      const data=await res.json();
      if(data.docs?.length){
        return data.docs.slice(0,12).map(doc=>{
          let coverUrl=null;
          if(doc.cover_edition_key) coverUrl=`https://covers.openlibrary.org/b/olid/${doc.cover_edition_key}-M.jpg`;
          else if(doc.cover_i) coverUrl=`https://covers.openlibrary.org/b/id/${doc.cover_i}-M.jpg`;
          else if(doc.isbn?.[0]) coverUrl=`https://covers.openlibrary.org/b/isbn/${doc.isbn[0]}-M.jpg`;
          return{title:doc.title||'Unknown',author:(doc.author_name||['Unknown']).slice(0,2).join(', '),coverUrl,pages:doc.number_of_pages_median||0};
        }).filter(b=>b.title!=='Unknown');
      }
    }
  }catch(e){}
  return [];
}

// Keep searchOpenLibrary as alias used elsewhere
const searchOpenLibrary=searchBooks;

async function fetchCoverUrl(title,author){
  // Try Google Books first for cover
  try{
    const q=encodeURIComponent(`${title} ${author||''}`);
    const res=await fetch(`https://www.googleapis.com/books/v1/volumes?q=${q}&maxResults=3&printType=books`,{signal:AbortSignal.timeout(6000)});
    if(res.ok){
      const data=await res.json();
      for(const item of data.items||[]){
        const url=item.volumeInfo?.imageLinks?.thumbnail;
        if(url) return url.replace(/^http:/,'https:').replace('zoom=1','zoom=2');
      }
    }
  }catch(e){}
  // Fallback to Open Library
  try{
    const q=encodeURIComponent(`${title} ${author||''}`);
    const res=await fetch(`https://openlibrary.org/search.json?q=${q}&limit=5&fields=isbn,cover_edition_key,cover_i`,{signal:AbortSignal.timeout(7000)});
    if(res.ok){
      const data=await res.json();
      for(const doc of data.docs||[]){
        if(doc.cover_edition_key) return `https://covers.openlibrary.org/b/olid/${doc.cover_edition_key}-L.jpg`;
        if(doc.cover_i) return `https://covers.openlibrary.org/b/id/${doc.cover_i}-L.jpg`;
        if(doc.isbn?.[0]) return `https://covers.openlibrary.org/b/isbn/${doc.isbn[0]}-L.jpg`;
      }
    }
  }catch(e){}
  return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COVER IMAGE HELPER
//  Open Library returns a 1√ó1 transparent GIF for missing covers.
//  We check naturalWidth on load ‚Äî if < 10px it's a placeholder.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function makeCoverImg(coverUrl,color,title,cssClass,fallbackClass,fallbackStyle){
  if(!coverUrl) return `<div class="${fallbackClass}" style="background:linear-gradient(160deg,${color}60,${color}20);${fallbackStyle||''}">${title}</div>`;
  return `<img class="${cssClass}" src="${coverUrl}"
    onload="if(this.naturalWidth<10){this.style.display='none';this.nextElementSibling.style.display='flex';}"
    onerror="this.style.display='none';this.nextElementSibling.style.display='flex';"/>
    <div class="${fallbackClass}" style="display:none;background:linear-gradient(160deg,${color}60,${color}20);${fallbackStyle||''}">${title}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function readCount(){return books.filter(b=>b.status==='read').length;}
function totalPages(){return books.filter(b=>b.status==='read').reduce((a,b)=>a+b.pages,0);}
function avgRating(){const r=books.filter(b=>b.status==='read');return r.length?(r.reduce((a,b)=>a+b.rating,0)/r.length).toFixed(1):'‚Äì';}
function starsHtml(v,sz=12){return[1,2,3,4,5].map(s=>`<span style="color:${s<=v?'#c8a96e':'#2a2a38'};font-size:${sz}px">‚òÖ</span>`).join('');}
function uid(){return Date.now()+Math.floor(Math.random()*9999);}
const CY=new Date().getFullYear();
function yearlyBooks(){return books.filter(b=>b.status==='read'&&b.dateRead&&b.dateRead.startsWith(String(CY)));}
function fmtDate(iso){if(!iso)return null;const d=new Date(iso+'T00:00:00');return d.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});}
function todayISO(){return new Date().toISOString().slice(0,10);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAGE TURN SOUND
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let audioCtx=null;
function getAudioCtx(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx;}
function playPageTurnSound(){
  try{
    const ctx=getAudioCtx(),dur=0.6;
    const buf=ctx.createBuffer(1,ctx.sampleRate*dur,ctx.sampleRate);
    const d=buf.getChannelData(0);
    for(let i=0;i<d.length;i++){const t=i/ctx.sampleRate;d[i]=(Math.random()*2-1)*Math.exp(-t*7)*(1-Math.exp(-t*60));}
    const src=ctx.createBufferSource(); src.buffer=buf;
    const lpf=ctx.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=4500;
    const hpf=ctx.createBiquadFilter(); hpf.type='highpass'; hpf.frequency.value=500;
    const gain=ctx.createGain(); gain.gain.value=0.65;
    src.connect(hpf); hpf.connect(lpf); lpf.connect(gain); gain.connect(ctx.destination);
    src.start();
  }catch(e){}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LANDING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let landingBooks=[],landingRAF=null;

function renderLanding(){
  const canvas=document.getElementById('booksCanvas');
  canvas.innerHTML=''; landingBooks=[];
  if(landingRAF){cancelAnimationFrame(landingRAF);landingRAF=null;}
  const W=window.innerWidth,H=window.innerHeight;
  const count=Math.min(14,Math.max(books.length,5));
  for(let i=0;i<count;i++){
    const b=books[i%books.length];
    const w=70+(i%4)*20,h=Math.round(w*1.55);
    const x=Math.random()*(W-w),y=Math.random()*(H-h);
    const vx=(Math.random()-0.5)*0.3,vy=(Math.random()-0.5)*0.3;
    const r=(Math.random()-0.5)*14;
    const el=document.createElement('div');
    el.className='fbook';
    el.style.cssText=`left:0;top:0;width:${w}px;position:absolute;`;
    const inner=document.createElement('div');
    inner.className='fbook-inner';
    inner.style.cssText=`width:${w}px;height:${h}px;`;
    if(b.coverUrl){
      const img=document.createElement('img');
      img.src=b.coverUrl;
      img.style.cssText='width:100%;height:100%;object-fit:cover;display:block;';
      img.onload=function(){if(this.naturalWidth<10){this.style.display='none';showFallback(inner,b);}};
      img.onerror=function(){this.style.display='none';showFallback(inner,b);};
      inner.appendChild(img);
    } else {showFallback(inner,b);}
    el.appendChild(inner);
    canvas.appendChild(el);
    const obj={el,inner,x,y,vx,vy,w,h,r,book:b,pinnedVx:vx,pinnedVy:vy,pinned:false};
    landingBooks.push(obj);
    applyTransform(obj);
    el.addEventListener('mouseenter',()=>{obj.pinned=true;obj.vx=0;obj.vy=0;inner.style.boxShadow='0 0 0 2px #c8a96e,0 0 60px rgba(200,169,110,0.55),8px 12px 50px rgba(0,0,0,0.85)';el.style.zIndex='10';});
    el.addEventListener('mouseleave',()=>{obj.pinned=false;inner.style.boxShadow='';el.style.zIndex='';obj.vx=obj.pinnedVx;obj.vy=obj.pinnedVy;});
  }
  animateLanding();
}
function showFallback(inner,b){
  const fb=document.createElement('div');
  fb.className='fbook-fallback';
  fb.style.background=`linear-gradient(160deg,${b.color}70,${b.color}25)`;
  fb.textContent=b.title;
  inner.appendChild(fb);
}
function applyTransform(obj){obj.el.style.transform=`translate(${obj.x}px,${obj.y}px) rotate(${obj.r}deg)`;}
function animateLanding(){
  const W=window.innerWidth,H=window.innerHeight;
  for(const obj of landingBooks){
    if(!obj.pinned){
      obj.x+=obj.vx; obj.y+=obj.vy;
      if(obj.x<0){obj.x=0;obj.vx=Math.abs(obj.vx);}
      if(obj.x>W-obj.w){obj.x=W-obj.w;obj.vx=-Math.abs(obj.vx);}
      if(obj.y<0){obj.y=0;obj.vy=Math.abs(obj.vy);}
      if(obj.y>H-obj.h){obj.y=H-obj.h;obj.vy=-Math.abs(obj.vy);}
      applyTransform(obj);
    }
  }
  landingRAF=requestAnimationFrame(animateLanding);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION & TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTracker(){
  playPageTurnSound();
  document.getElementById('landing').style.display='none';
  document.getElementById('landingFab').style.display='none';
  if(landingRAF){cancelAnimationFrame(landingRAF);landingRAF=null;}
  document.getElementById('tracker').style.display='block';
  renderTracker();
}
function showLanding(){
  document.getElementById('tracker').style.display='none';
  document.getElementById('landing').style.display='flex';
  document.getElementById('landingFab').style.display='flex';
  renderLanding();
}
function openModalFromLanding(){showTracker();setTimeout(()=>openModal('add'),50);}

function switchTab(tab){
  const isLib=tab==='library';
  document.getElementById('libraryView').style.display=isLib?'block':'none';
  document.getElementById('profileView').style.display=isLib?'none':'block';
  document.getElementById('navLibrary').classList.toggle('active',isLib);
  document.getElementById('navProfile').classList.toggle('active',!isLib);
  if(!isLib) renderProfile();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  YEARLY CHALLENGE PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderChallenge(){
  const yBooks=yearlyBooks();
  const done=yBooks.length;
  const pct=Math.min(100,Math.round((done/yearGoal)*100));

  // Pace: how many books should we have read by now?
  const now=new Date();
  const dayOfYear=Math.floor((now-new Date(CY,0,1))/86400000)+1;
  const daysInYear=((CY%4===0&&CY%100!==0)||CY%400===0)?366:365;
  const expectedByNow=(yearGoal*dayOfYear/daysInYear);
  const diff=done-expectedByNow;
  let paceLabel,paceClass;
  if(diff>0.75){paceLabel=`${Math.ceil(diff)} book${Math.ceil(diff)>1?'s':''} ahead`;paceClass='ahead';}
  else if(diff<-0.75){paceLabel=`${Math.ceil(Math.abs(diff))} book${Math.ceil(Math.abs(diff))>1?'s':''} behind`;paceClass='behind';}
  else{paceLabel='On pace';paceClass='on-track';}

  // Spine slots
  const maxSlots=Math.max(yearGoal,done);
  const colors=["#c8a96e","#7c6af5","#4ec994","#e05c5c","#74b9ff","#fd79a8","#fdcb6e","#a29bfe","#e17055","#55efc4"];
  const sortedY=[...yBooks].sort((a,b)=>a.dateRead.localeCompare(b.dateRead));
  const spines=Array.from({length:maxSlots},(_, i)=>{
    const b=sortedY[i];
    if(b){
      const c=b.color||colors[i%colors.length];
      return`<div class="spine-slot filled" style="background:linear-gradient(180deg,${c}ee,${c}88);">
        <div class="spine-tip">${b.title}</div>
      </div>`;
    }
    return`<div class="spine-slot empty"></div>`;
  }).join('');

  // Month heatmap
  const monthNames=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const monthlyCounts=Array(12).fill(0);
  yBooks.forEach(b=>{const m=new Date(b.dateRead+'T00:00:00').getMonth();monthlyCounts[m]++;});
  const maxM=Math.max(...monthlyCounts,1);
  const curMonth=now.getMonth();
  const monthBars=monthNames.map((m,i)=>{
    const h=Math.max(4,Math.round((monthlyCounts[i]/maxM)*36));
    const isActive=i===curMonth;
    const style=monthlyCounts[i]>0?`height:${h}px;opacity:${isActive?1:0.7}`:`height:3px;background:var(--bg3);opacity:0.4`;
    const barStyle=monthlyCounts[i]>0?`style="${style}"`:`style="${style}"`;
    return`<div class="month-cell">
      <div class="month-bar" ${barStyle}></div>
      <div class="month-cnt">${monthlyCounts[i]}</div>
      <div class="month-lbl" style="color:${isActive?'var(--accent)':''};">${m}</div>
    </div>`;
  }).join('');

  // Pace line position on bar
  const pacePct=Math.min(100,Math.round((expectedByNow/yearGoal)*100));

  document.getElementById('challengePanel').innerHTML=`
    <div class="challenge-top">
      <div>
        <div class="challenge-count">
          <span class="challenge-num">${done}</span>
          <span class="challenge-denom">/ ${yearGoal}</span>
        </div>
        <div class="challenge-label">${CY} Reading Challenge ¬∑ ${done===0?'Get started!':done===yearGoal?'Goal reached! üéâ':`${yearGoal-done} to go`}</div>
      </div>
      <div class="challenge-right">
        <span class="pace-badge ${paceClass}">${paceLabel}</span>
        <button class="challenge-goal-btn" onclick="changeGoal()">‚öô Change goal</button>
      </div>
    </div>
    <div class="spine-track">${spines}</div>
    <div class="challenge-bar-wrap">
      <div class="challenge-bar-labels">
        <span>0</span><span>${Math.round(yearGoal/4)}</span><span>${Math.round(yearGoal/2)}</span><span>${Math.round(yearGoal*3/4)}</span><span>${yearGoal}</span>
      </div>
      <div class="challenge-bar">
        <div class="challenge-bar-fill" style="width:${pct}%"></div>
        <div class="challenge-bar-pace" style="left:${pacePct}%" title="Expected by today"></div>
      </div>
    </div>
    <div class="month-row">${monthBars}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TRACKER RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTracker(){
  const search=(document.getElementById('searchInput')?.value||'').toLowerCase();
  const sortBy=document.getElementById('sortSel')?.value||'newest';

  const yDone=yearlyBooks().length;
  document.getElementById('tStats').innerHTML=`
    <div class="tstat">All time: <span>${readCount()} read</span></div>
    <div class="tstat">Pages: <span>${totalPages().toLocaleString()}</span></div>
    <div class="tstat">${CY}: <span>${yDone} / ${yearGoal}</span></div>`;

  renderChallenge();
  // Fire background cover fetch ‚Äî fills in missing covers without blocking render
  setTimeout(fetchMissingCovers, 200);

  // Currently reading
  const crBooks=books.filter(b=>b.status==='reading');
  document.getElementById('crCount').textContent=`${crBooks.length} book${crBooks.length!==1?'s':''}`;
  document.getElementById('crGrid').innerHTML=crBooks.length?crBooks.map(b=>{
    const pct=b.pages?Math.round((b.currentPage/b.pages)*100):0;
    const coverHtml=b.coverUrl
      ?`<img class="cr-cover" src="${b.coverUrl}"
          onload="if(this.naturalWidth<10){this.style.display='none';this.nextElementSibling.style.display='flex';}"
          onerror="this.style.display='none';this.nextElementSibling.style.display='flex';"/>
         <div class="cr-cover-ph" style="display:none;background:${b.color}30">üìñ</div>`
      :`<div class="cr-cover-ph" style="background:${b.color}30">üìñ</div>`;
    return`<div class="cr-card">
      <div class="cr-top"><div style="flex-shrink:0;">${coverHtml}</div>
        <div class="cr-info"><h4>${b.title}</h4><p>by ${b.author}</p><span class="cr-badge">${b.genre}</span></div>
      </div>
      <div class="progress-label"><span>Progress</span><span>${b.currentPage||0} / ${b.pages} pages ¬∑ ${pct}%</span></div>
      <div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div>
      <div class="page-input-row">
        <input type="number" id="pg_${b.id}" placeholder="${b.currentPage||0}" min="0" max="${b.pages}"/>
        <button onclick="updateProgress(${b.id})">Update</button>
        <button onclick="markRead(${b.id})">‚úì Finished</button>
      </div>
    </div>`;
  }).join(''):`<p style="color:var(--muted);font-style:italic;font-size:13px;padding:4px 0;">Nothing in progress ‚Äî add a book you're currently reading!</p>`;

  // Library grid
  let filtered=books.filter(b=>b.status==='read');
  if(search) filtered=filtered.filter(b=>b.title.toLowerCase().includes(search)||b.author.toLowerCase().includes(search));
  filtered.sort((a,b)=>{
    if(sortBy==='rating') return b.rating-a.rating;
    if(sortBy==='pages') return b.pages-a.pages;
    if(sortBy==='alpha') return a.title.localeCompare(b.title);
    if(sortBy==='date') return (b.dateRead||'').localeCompare(a.dateRead||'');
    return b.id-a.id;
  });
  document.getElementById('libCount').textContent=`${filtered.length} book${filtered.length!==1?'s':''}${search?' (filtered)':''}`;
  document.getElementById('bookGrid').innerHTML=filtered.length?filtered.map(b=>{
    const dateLabel=b.dateRead?fmtDate(b.dateRead):'No date';
    const dateColor=b.dateRead&&b.dateRead.startsWith(String(CY))?'color:var(--accent)':'';
    return`<div class="mag-card">
      <div class="mc-cover-wrap" id="cover-wrap-${b.id}" style="background:linear-gradient(160deg,${b.color}40,${b.color}15);">
        ${makeCoverImg(b.coverUrl,b.color,b.title,'mc-cover-img','mc-cover-fallback','')}
      </div>
      <div class="mc-info">
        <div class="mc-title">${b.title}</div>
        <div class="mc-author">by ${b.author}</div>
        <div class="mc-stars">${starsHtml(b.rating)}</div>
        <div class="mc-date" id="date-display-${b.id}">
          <span style="${dateColor}">${dateLabel}</span>
          <span class="mc-date-edit" title="Edit date" onclick="editDateInline(${b.id})">‚úé</span>
        </div>
        <div class="mc-actions">
          <button class="mc-btn" onclick="openModal('edit',${b.id})">Edit</button>
          <button class="mc-btn" onclick="openShare(${b.id})">Share</button>
          <button class="mc-btn danger" onclick="removeBook(${b.id})">Remove</button>
        </div>
      </div>
    </div>`}).join('')
    : search
      ? `<div class="empty-state-filter">
          <p>No books in your library matching "<em>${search}</em>"</p>
          <button onclick="clearLibrarySearch()">‚úï Clear filter ‚Äî show all books</button>
          <p style="margin-top:12px;font-size:12px;">‚Üë Pick a result from the search dropdown above to add it to your library</p>
        </div>`
      : `<div class="empty-state">Your library is empty ‚Äî add your first book!</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BACKGROUND COVER FETCHER
//  Runs silently after render. Fetches covers for any book that has
//  coverUrl===null (never tried). Marks failures as 'none' so we
//  don't retry every render. Updates DOM directly ‚Äî no re-render flash.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _coverFetching=new Set(); // guard: don't double-fetch same id

async function fetchMissingCovers(){
  // Only books with no cover that we haven't already tried this session
  const missing=books.filter(b=>b.coverUrl===null&&!_coverFetching.has(b.id));
  if(!missing.length) return;

  // Process in batches of 6 with a short gap to avoid hammering APIs
  const BATCH=6, DELAY=500;
  for(let i=0;i<missing.length;i+=BATCH){
    const batch=missing.slice(i,i+BATCH);
    await Promise.all(batch.map(async b=>{
      _coverFetching.add(b.id);
      const url=await fetchCoverUrl(b.title,b.author);
      // Store result ‚Äî empty string means "tried, nothing found"
      b.coverUrl=url||'';
      saveAll();
      // Update the card's cover-wrap in the DOM directly
      const wrap=document.getElementById(`cover-wrap-${b.id}`);
      if(!wrap) return;
      if(url){
        wrap.innerHTML=makeCoverImg(url,b.color,b.title,'mc-cover-img','mc-cover-fallback','');
      }
      // If no cover found, the existing coloured fallback stays ‚Äî nothing to do
    }));
    if(i+BATCH<missing.length) await new Promise(r=>setTimeout(r,DELAY));
  }
}

function removeBook(id){if(confirm('Remove this book?')){books=books.filter(b=>b.id!==id);saveAll();renderTracker();}}
function updateProgress(id){
  const val=parseInt(document.getElementById(`pg_${id}`).value);
  const book=books.find(b=>b.id===id);
  if(book&&!isNaN(val)&&val>=0){book.currentPage=Math.min(val,book.pages||val);saveAll();renderTracker();}
}
let markReadTargetId=null;
function markRead(id){
  const b=books.find(x=>x.id===id); if(!b) return;
  markReadTargetId=id;
  document.getElementById('finishedDateInput').value=b.dateRead||todayISO();
  document.getElementById('finishedModal').style.display='flex';
  setTimeout(()=>document.getElementById('finishedDateInput').focus(),80);
}
function confirmMarkRead(){
  const b=books.find(x=>x.id===markReadTargetId); if(!b) return;
  b.status='read';
  b.currentPage=b.pages;
  b.dateRead=document.getElementById('finishedDateInput').value||todayISO();
  saveAll();
  document.getElementById('finishedModal').style.display='none';
  renderTracker();
}
function changeGoal(){
  const v=prompt(`Set your ${CY} reading goal:`,yearGoal);
  if(v&&!isNaN(v)&&parseInt(v)>0){yearGoal=parseInt(v);saveAll();renderTracker();}
}

// Inline date editing on library cards
function editDateInline(id){
  const b=books.find(x=>x.id===id); if(!b) return;
  const wrap=document.getElementById(`date-display-${id}`);
  if(!wrap) return;
  wrap.innerHTML=`<input class="mc-date-input" type="date" value="${b.dateRead||todayISO()}" 
    onblur="saveInlineDate(${id},this.value)" 
    onkeydown="if(event.key==='Enter')this.blur();if(event.key==='Escape'){renderTracker();}" 
    autofocus/>`;
  wrap.querySelector('input').focus();
}
function saveInlineDate(id,val){
  const b=books.find(x=>x.id===id); if(!b) return;
  b.dateRead=val||null;
  saveAll();
  renderTracker();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderProfile(){
  // Avatar initials
  const initials=readerName.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2)||'R';
  document.getElementById('profileAvatar').textContent=initials;
  document.getElementById('profileNameText').textContent=readerName;
  const joinYear=new Date().getFullYear();
  document.getElementById('profileSub').textContent=`Bookverse member ¬∑ Goal: ${yearGoal} books in ${joinYear}`;

  // Stats
  const readBooks=books.filter(b=>b.status==='read');
  const readingBooks=books.filter(b=>b.status==='reading');
  const totalPg=readBooks.reduce((a,b)=>a+b.pages,0);
  const avgR=readBooks.length?(readBooks.reduce((a,b)=>a+b.rating,0)/readBooks.length).toFixed(1):'‚Äì';
  const topGenreEntry=Object.entries(readBooks.reduce((acc,b)=>{acc[b.genre]=(acc[b.genre]||0)+1;return acc;},{})).sort((a,b)=>b[1]-a[1])[0];
  document.getElementById('statsGrid').innerHTML=`
    <div class="stat-card"><div class="stat-num" style="color:var(--accent)">${readBooks.length}</div><div class="stat-label">Books Read</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--accent2)">${totalPg.toLocaleString()}</div><div class="stat-label">Pages Turned</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--green)">${avgR}</div><div class="stat-label">Avg Rating</div></div>
    <div class="stat-card"><div class="stat-num" style="color:var(--red)">${readingBooks.length}</div><div class="stat-label">In Progress</div></div>
    <div class="stat-card"><div class="stat-num" style="color:#74b9ff;font-size:24px;padding-top:4px;">${topGenreEntry?topGenreEntry[0]:'‚Äì'}</div><div class="stat-label">Favourite Genre</div></div>`;

  // Genre breakdown
  const genreMap=readBooks.reduce((acc,b)=>{acc[b.genre]=(acc[b.genre]||0)+1;return acc;},{});
  const maxG=Math.max(...Object.values(genreMap),1);
  const sorted=Object.entries(genreMap).sort((a,b)=>b[1]-a[1]);
  document.getElementById('genresWrap').innerHTML=sorted.length
    ?sorted.map(([g,c])=>`
      <div class="genre-bar-row">
        <div class="genre-bar-label">${g}</div>
        <div class="genre-bar-track"><div class="genre-bar-fill" style="width:${Math.round((c/maxG)*100)}%"></div></div>
        <div class="genre-bar-count">${c}</div>
      </div>`).join('')
    :`<p style="color:var(--muted);font-style:italic;font-size:13px;">Add books to your library to see genre breakdown.</p>`;
}

function editName(){
  const display=document.getElementById('profileNameDisplay');
  const input=document.getElementById('profileNameInput');
  display.style.display='none';
  input.style.display='block';
  input.value=readerName;
  input.focus();
  input.select();
}
function saveName(){
  const input=document.getElementById('profileNameInput');
  const display=document.getElementById('profileNameDisplay');
  const val=input.value.trim();
  if(val) readerName=val;
  saveAll();
  input.style.display='none';
  display.style.display='inline-flex';
  document.getElementById('profileNameText').textContent=readerName;
  document.getElementById('profileAvatar').textContent=readerName.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2)||'R';
  document.getElementById('profileSub').textContent=`Bookverse member ¬∑ Goal: ${yearGoal} books in ${new Date().getFullYear()}`;
}

function exportLibrary(){
  const data={books,yearGoal,readerName,exported:new Date().toISOString()};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`bookverse-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}
function importLibrary(e){
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=function(ev){
    try{
      const data=JSON.parse(ev.target.result);
      if(!Array.isArray(data.books)) throw new Error('Invalid format');
      if(!confirm(`Import ${data.books.length} books from backup? This will replace your current library.`)) return;
      books=data.books;
      if(data.yearGoal) yearGoal=data.yearGoal;
      if(data.readerName) readerName=data.readerName;
      saveAll();
      renderTracker();
      renderProfile();
      renderLanding();
      alert(`‚úì ${books.length} books imported successfully!`);
    }catch(err){alert('Could not read file. Make sure it\'s a valid Bookverse backup.');}
  };
  reader.readAsText(file);
  e.target.value='';
}
function clearLibrary(){
  if(confirm('Clear your entire library? This cannot be undone.\n\nTip: Export first to save a backup.')){
    books=[];saveAll();renderTracker();renderProfile();renderLanding();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LIVE LIBRARY SEARCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleLibrarySearch(){
  const q=(document.getElementById('searchInput').value||'').trim();
  // Show/hide clear button
  const clrBtn=document.getElementById('searchClear');
  if(clrBtn) clrBtn.style.display=q?'block':'none';
  renderTracker();
  const dropdown=document.getElementById('searchDropdown');
  if(q.length<2){dropdown.classList.remove('open');return;}
  clearTimeout(searchDebounce);
  dropdown.innerHTML='<div class="sdrop-loading">Searching‚Ä¶</div>';
  dropdown.classList.add('open');
  searchDebounce=setTimeout(async()=>{
    const results=await searchOpenLibrary(q);
    if(!results.length){dropdown.innerHTML='<div class="sdrop-loading">No results found</div>';return;}
    dropdown.innerHTML=results.map((r,i)=>`
      <div class="sdrop-item" onclick="addFromSearch(${i})">
        ${r.coverUrl?`<img src="${r.coverUrl}" onload="if(this.naturalWidth<10)this.style.display='none'" onerror="this.style.display='none'"/>`:''}
        <div class="sdrop-info"><strong>${r.title}</strong><span>${r.author}${r.pages?' ¬∑ '+r.pages+' pages':''}</span></div>
      </div>`).join('');
    dropdown._results=results;
  },500);
}

function clearLibrarySearch(){
  document.getElementById('searchInput').value='';
  const clrBtn=document.getElementById('searchClear');
  if(clrBtn) clrBtn.style.display='none';
  document.getElementById('searchDropdown').classList.remove('open');
  renderTracker();
  document.getElementById('searchInput').focus();
}
function addFromSearch(idx){
  const dropdown=document.getElementById('searchDropdown');
  const r=dropdown._results?.[idx]; if(!r) return;
  dropdown.classList.remove('open');
  // Clear the search so the library isn't filtered after adding
  document.getElementById('searchInput').value='';
  const clrBtn=document.getElementById('searchClear');
  if(clrBtn) clrBtn.style.display='none';
  openModal('add');
  setTimeout(()=>{
    document.getElementById('fTitle').value=r.title;
    document.getElementById('fAuthor').value=r.author;
    if(r.pages) document.getElementById('fPages').value=r.pages;
    if(r.coverUrl){
      pendingCoverUrl=r.coverUrl;
      document.getElementById('coverPreview').innerHTML=`<img src="${r.coverUrl}" style="width:100%;height:100%;object-fit:cover;"/>`;
    }
  },50);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADD / EDIT MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let modalSearchDebounce=null,modalSearchResults=[];
function openModal(mode,id=null){
  editingId=id; selRating=4; selStatus='read'; pendingCoverUrl=null; modalSearchResults=[];
  ['fTitle','fAuthor','fPages','fCurrentPage'].forEach(f=>document.getElementById(f).value='');
  document.getElementById('fGenre').value='Fantasy';
  document.getElementById('fDateRead').value=todayISO();
  document.getElementById('coverPreview').innerHTML='<span style="padding:4px;font-size:9px;text-align:center;">No cover</span>';
  document.getElementById('modalSearchDropdown').classList.remove('open');
  document.getElementById('modalTitle').textContent='Add a Book';
  if(id){
    const b=books.find(x=>x.id===id);
    if(b){
      selRating=b.rating; selStatus=b.status;
      document.getElementById('fTitle').value=b.title;
      document.getElementById('fAuthor').value=b.author;
      document.getElementById('fPages').value=b.pages;
      document.getElementById('fCurrentPage').value=b.currentPage||0;
      document.getElementById('fGenre').value=b.genre;
      document.getElementById('fDateRead').value=b.dateRead||todayISO();
      document.getElementById('modalTitle').textContent='Edit Book';
      if(b.coverUrl){pendingCoverUrl=b.coverUrl;document.getElementById('coverPreview').innerHTML=`<img src="${b.coverUrl}" style="width:100%;height:100%;object-fit:cover;"/>`;}
    }
  }
  renderModalStars(); setStatus(selStatus);
  document.getElementById('addModal').style.display='flex';
}
function closeOverlay(e,id){if(e.target.id===id)document.getElementById(id).style.display='none';}
function setStatus(s){
  selStatus=s;
  document.getElementById('statusRead').classList.toggle('sel',s==='read');
  document.getElementById('statusReading').classList.toggle('sel',s==='reading');
  document.getElementById('currentPageFg').style.display=s==='reading'?'block':'none';
  document.getElementById('dateReadFg').style.display=s==='read'?'block':'none';
}
function renderModalStars(){
  document.getElementById('mStars').innerHTML=[1,2,3,4,5].map(s=>
    `<span class="m-star${s<=selRating?' on':''}" onclick="selRating=${s};renderModalStars()">‚òÖ</span>`).join('');
}
function onModalSearchInput(){
  const title=document.getElementById('fTitle').value.trim();
  const author=document.getElementById('fAuthor').value.trim();
  const q=title.length>=5?title:author.length>=5?author:'';
  const dropdown=document.getElementById('modalSearchDropdown');
  if(!q){dropdown.classList.remove('open');return;}
  clearTimeout(modalSearchDebounce);
  dropdown.innerHTML='<div class="msdrop-loading">Searching‚Ä¶</div>';
  dropdown.classList.add('open');
  modalSearchDebounce=setTimeout(async()=>{
    const results=await searchOpenLibrary(q);
    modalSearchResults=results;
    if(!results.length){dropdown.innerHTML='<div class="msdrop-loading">No results found</div>';return;}
    dropdown.innerHTML=results.map((r,i)=>`
      <div class="msdrop-item" onclick="selectModalBook(${i})">
        ${r.coverUrl?`<img src="${r.coverUrl}" onload="if(this.naturalWidth<10)this.style.display='none'" onerror="this.style.display='none'"/>`:''}
        <div class="msdrop-info"><strong>${r.title}</strong><span>${r.author}${r.pages?' ¬∑ '+r.pages+' pages':''}</span></div>
      </div>`).join('');
  },400);
}
function selectModalBook(idx){
  const r=modalSearchResults[idx]; if(!r) return;
  document.getElementById('modalSearchDropdown').classList.remove('open');
  document.getElementById('fTitle').value=r.title;
  document.getElementById('fAuthor').value=r.author;
  if(r.pages>0) document.getElementById('fPages').value=r.pages;
  if(r.coverUrl){
    pendingCoverUrl=r.coverUrl;
    document.getElementById('coverPreview').innerHTML=`<img src="${r.coverUrl}" style="width:100%;height:100%;object-fit:cover;"/>`;
  }
}
document.addEventListener('click',e=>{
  if(!e.target.closest('#addModal')) document.getElementById('modalSearchDropdown')?.classList.remove('open');
  if(!e.target.closest('.search-wrap')) document.getElementById('searchDropdown')?.classList.remove('open');
});
async function saveBook(){
  const title=document.getElementById('fTitle').value.trim();
  const author=document.getElementById('fAuthor').value.trim();
  const pagesRaw=document.getElementById('fPages').value.trim();
  const pages=parseInt(pagesRaw);
  const genre=document.getElementById('fGenre').value;
  if(!title){alert('Please enter the book title.');document.getElementById('fTitle').focus();return;}
  if(!author){alert('Please enter the author name.');document.getElementById('fAuthor').focus();return;}
  const finalPages=(!pagesRaw||isNaN(pages)||pages<=0)?0:pages;
  const currentPage=selStatus==='reading'?parseInt(document.getElementById('fCurrentPage').value)||0:finalPages;
  const dateRead=selStatus==='read'?(document.getElementById('fDateRead').value||todayISO()):null;
  let coverUrl=pendingCoverUrl;
  if(!coverUrl) coverUrl=await fetchCoverUrl(title,author);
  const color=FALLBACK_COLORS[books.length%FALLBACK_COLORS.length];
  if(editingId){
    const i=books.findIndex(b=>b.id===editingId);
    if(i>-1) books[i]={...books[i],title,author,pages:finalPages,currentPage,genre,rating:selRating,status:selStatus,dateRead:dateRead!==undefined?dateRead:books[i].dateRead,coverUrl:coverUrl||books[i].coverUrl};
  } else {
    books.push({id:uid(),title,author,pages:finalPages,currentPage,genre,rating:selRating,status:selStatus,dateRead,color,coverUrl:coverUrl||null});
  }
  saveAll();
  document.getElementById('addModal').style.display='none';
  renderTracker();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SHARE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openShare(id){
  shareBookId=id; const b=books.find(x=>x.id===id); if(!b) return;
  const coverEl=b.coverUrl?`<img class="sp-cover" src="${b.coverUrl}" onload="if(this.naturalWidth<10)this.style.display='none'" onerror="this.style.display='none'"/>`:`<div class="sp-cover-ph">üìö</div>`;
  document.getElementById('sharePreview').innerHTML=`${coverEl}<div class="sp-details"><div class="sp-title">${b.title}</div><div class="sp-author">by ${b.author}</div><div style="color:#c8a96e;margin-bottom:10px;">${starsHtml(b.rating,14)}</div><div class="sp-quote">A standout ${b.genre.toLowerCase()} ‚Äî ${b.pages} pages I won't forget.</div></div>`;
  document.getElementById('shareModal').style.display='flex';
}
function copyShareText(){
  const b=books.find(x=>x.id===shareBookId); if(!b) return;
  const text=`üìö "${b.title}" by ${b.author}\n${'‚òÖ'.repeat(b.rating)}${'‚òÜ'.repeat(5-b.rating)} ¬∑ ${b.genre} ¬∑ ${b.pages} pages\n\nHighly recommend! #BookRecommendation`;
  navigator.clipboard.writeText(text).then(()=>{const m=document.getElementById('copiedMsg');m.style.display='block';setTimeout(()=>m.style.display='none',2500);});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GOODREADS IMPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleFileDrop(e){e.preventDefault();document.getElementById('importDrop').classList.remove('drag-over');const file=e.dataTransfer.files[0];if(file)parseGoodreadsCSV(file);}
function handleFileSelect(e){const file=e.target.files[0];if(file)parseGoodreadsCSV(file);}
function parseGoodreadsCSV(file){
  const reader=new FileReader();
  reader.onload=function(ev){
    const text=ev.target.result;
    const rows=text.split('\n').filter(r=>r.trim());
    if(rows.length<2){alert("Couldn't read this file.");return;}
    const headers=parseCSVRow(rows[0]).map(h=>h.toLowerCase().trim().replace(/"/g,''));
    const col=name=>headers.findIndex(h=>h.includes(name));
    const titleIdx=col('title'),authorIdx=col('author'),pagesIdx=col('number of pages');
    const ratingIdx=col('my rating'),shelfIdx=col('exclusive shelf');
    if(titleIdx===-1){alert("Title column not found. Make sure this is a Goodreads export.");return;}
    parsedImportBooks=[];
    for(let i=1;i<rows.length;i++){
      const cols=parseCSVRow(rows[i]);
      if(!cols[titleIdx]) continue;
      const title=cols[titleIdx]?.replace(/^"|"$/g,'').trim();
      if(!title) continue;
      const author=(cols[authorIdx]||'Unknown').replace(/^"|"$/g,'').trim();
      const pages=parseInt(cols[pagesIdx])||200;
      const rating=Math.min(5,Math.max(0,parseInt(cols[ratingIdx])||0));
      const shelf=(cols[shelfIdx]||'read').replace(/^"|"$/g,'').trim().toLowerCase();
      if(shelf==='to-read') continue;
      if(books.find(b=>b.title.toLowerCase()===title.toLowerCase())) continue;
      const status=shelf==='currently-reading'?'reading':'read';
      parsedImportBooks.push({title,author,pages,rating:rating||4,status,currentPage:status==='reading'?0:pages,coverUrl:null,color:FALLBACK_COLORS[parsedImportBooks.length%FALLBACK_COLORS.length]});
    }
    renderImportResults();
  };
  reader.readAsText(file);
}
function parseCSVRow(row){
  const result=[]; let cur=''; let inQ=false;
  for(const ch of row){if(ch==='"'){inQ=!inQ;}else if(ch===','&&!inQ){result.push(cur);cur='';}else{cur+=ch;}}
  result.push(cur); return result;
}
function renderImportResults(){
  const container=document.getElementById('importResults');
  const actions=document.getElementById('importActions');
  if(!parsedImportBooks.length){
    container.style.display='block';
    container.innerHTML='<p style="color:var(--muted);font-style:italic;font-size:13px;text-align:center;padding:16px;">No new books found ‚Äî all may already be in your library.</p>';
    actions.style.display='none'; return;
  }
  document.getElementById('importCount').textContent=`${parsedImportBooks.length} books found`;
  container.style.display='block'; actions.style.display='block';
  container.innerHTML=parsedImportBooks.map((b,i)=>`
    <div class="import-book-row">
      <img id="imp-img-${i}" src="" style="display:none;width:32px;height:48px;object-fit:cover;border-radius:2px;flex-shrink:0;"/>
      <div class="import-book-info"><strong>${b.title}</strong><span>${b.author} ¬∑ ${b.status==='reading'?'‚ñ∂ Reading':'‚úì Read'} ¬∑ ${b.rating}‚òÖ</span></div>
      <input type="checkbox" class="import-book-check" data-idx="${i}" checked/>
    </div>`).join('');
  // Fetch covers asynchronously and update UI + parsedImportBooks
  parsedImportBooks.forEach(async(b,i)=>{
    const url=await fetchCoverUrl(b.title,b.author);
    if(url){
      parsedImportBooks[i].coverUrl=url;
      const img=document.getElementById(`imp-img-${i}`);
      if(img){
        img.src=url;
        img.style.display='block';
        img.onload=function(){if(this.naturalWidth<10)this.style.display='none';};
        img.onerror=function(){this.style.display='none';};
      }
    }
  });
}
function toggleSelectAll(checked){document.querySelectorAll('.import-book-check').forEach(cb=>cb.checked=checked);}
async function importSelected(){
  const checked=[...document.querySelectorAll('.import-book-check:checked')].map(cb=>parseInt(cb.dataset.idx));
  if(!checked.length){alert('Select at least one book.');return;}
  const btn=document.querySelector('#importActions .mbtn-primary');
  btn.textContent='Importing‚Ä¶'; btn.disabled=true;
  let added=0;
  for(const idx of checked){
    const b=parsedImportBooks[idx];
    books.push({
      id:uid(),
      title:b.title, author:b.author, pages:b.pages,
      currentPage:b.currentPage, genre:'Fiction',
      rating:b.rating, status:b.status,
      dateRead:b.status==='read'?todayISO():null,
      color:FALLBACK_COLORS[(books.length)%FALLBACK_COLORS.length],
      coverUrl:b.coverUrl||null
    });
    added++;
  }
  saveAll(); // persist immediately
  const statusEl=document.getElementById('importStatus');
  statusEl.textContent=`‚úì ${added} book${added!==1?'s':''} saved to your library!`;
  statusEl.style.display='block';
  setTimeout(()=>{
    document.getElementById('importModal').style.display='none';
    statusEl.style.display='none';
    btn.textContent='Import Selected Books'; btn.disabled=false;
    document.getElementById('importResults').style.display='none';
    document.getElementById('importActions').style.display='none';
    parsedImportBooks=[]; document.getElementById('csvFileInput').value='';
    renderTracker(); renderLanding();
  },1500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AI INSIGHT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function getAIInsight(){
  const btn=document.getElementById('aiBtn'),res=document.getElementById('aiResult');
  btn.disabled=true; btn.textContent='‚ú¶ Analysing‚Ä¶'; res.style.display='none';
  try{
    const list=books.filter(b=>b.status==='read').map(b=>`"${b.title}" by ${b.author} (${b.genre}, ${b.rating}/5)`).join(', ');
    const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,messages:[{role:'user',
        content:`Based on my reading list: ${list}. In 2-3 sentences give a sophisticated literary insight about my reading taste, then recommend one specific book I'd love. Be like an erudite literary critic ‚Äî specific, insightful, not generic.`}]})});
    const d=await r.json();
    res.innerHTML=d.content[0].text.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
  }catch(e){
    res.innerHTML='Your reading list suggests a mind drawn to <strong>big ideas and world-building</strong>. Consider <strong>The Name of the Wind</strong> by Patrick Rothfuss.';
  }
  res.style.display='block'; btn.disabled=false; btn.textContent='‚ú¶ Analyse My Taste';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
renderLanding();
</script>
</body>
</html>
